{% extends 'admin_panel/base_site.html' %}
{% load static %}
{% load permission_tags %}
{% block content %}
<div class="container mx-auto py-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-blue-800">Manage Rooms</h2>
        {% if request.user|has_perm:"add_room" %}
        <a href="{% url 'admin_panel:admin_add_room' %}" class="btn btn-primary">Add Room</a>
        {% endif %}
    </div>
    <div class="bg-white rounded-lg shadow p-6 overflow-x-auto">
        <table class="w-full min-w-[900px] divide-y divide-gray-200 text-sm">
            <thead class="bg-blue-50">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-blue-700 uppercase whitespace-nowrap">ID</th>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-blue-700 uppercase whitespace-nowrap">Room Number</th>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-blue-700 uppercase whitespace-nowrap">Room Type</th>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-blue-700 uppercase whitespace-nowrap">Hotel</th>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-blue-700 uppercase whitespace-nowrap">Current Status</th>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-blue-700 uppercase whitespace-nowrap">Booking Details</th>
                    {% if request.user|has_perm:"edit_room" or request.user|has_perm:"delete_room" %}
                    <th class="px-4 py-2 text-left text-xs font-semibold text-blue-700 uppercase whitespace-nowrap">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
                {% for room_status in rooms_with_status %}
                <tr class="{% if room_status.is_currently_occupied %}bg-red-50{% elif not room_status.room.is_available %}bg-gray-50{% else %}bg-green-50{% endif %}">
                    <td class="px-4 py-2 whitespace-nowrap">{{ room_status.room.id }}</td>
                    <td class="px-4 py-2 whitespace-nowrap font-medium">{{ room_status.room.room_number }}</td>
                    <td class="px-4 py-2 whitespace-nowrap">{{ room_status.room.room_type }}</td>
                    <td class="px-4 py-2 whitespace-nowrap">{{ room_status.room.hotel }}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        {% if room_status.is_currently_occupied %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Occupied
                            </span>
                        {% elif not room_status.room.is_available %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                Disabled
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Available
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2">
                        {% if room_status.current_booking %}
                            <div class="text-xs">
                                <div class="font-medium text-red-600">Current Guest:</div>
                                <div>{{ room_status.current_booking.checkin }} - {{ room_status.current_booking.checkout }}</div>
                                <div class="text-gray-600">Status: {{ room_status.current_booking.status|title }}</div>
                            </div>
                        {% elif room_status.upcoming_booking %}
                            <div class="text-xs">
                                <div class="font-medium text-orange-600">Next Booking:</div>
                                <div>{{ room_status.upcoming_booking.checkin }} - {{ room_status.upcoming_booking.checkout }}</div>
                                <div class="text-gray-600">Status: {{ room_status.upcoming_booking.status|title }}</div>
                            </div>
                        {% else %}
                            <div class="text-xs text-gray-500">No current or upcoming bookings</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2 flex flex-col md:flex-row gap-2 whitespace-nowrap">
                        {% if request.user|has_perm:"edit_room" %}
                        <a href="{% url 'admin_panel:admin_edit_room' room_status.room.id %}" class="btn btn-sm btn-primary">Edit</a>
                        {% elif request.user|has_perm:"delete_room" %}
                        <button type="button" 
                                        class="btn btn-sm btn-danger soft-delete-btn" 
                                        title="Delete"
                                        data-item-name="Room {{ room_status.room.room_number }}"
                                        data-item-type="room"
                                        data-delete-url="{% url 'admin_panel:soft_delete_room' room_status.room.id %}"
                                        data-redirect-url="{% url 'admin_panel:admin_rooms' %}">
                                    Delete
                                </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-4 text-gray-500">No rooms found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Room Status Legend -->
    <div class="mt-6 bg-gray-50 rounded-lg p-4">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Status Legend:</h3>
        <div class="flex flex-wrap gap-4 text-xs">
            <div class="flex items-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-2">
                    Occupied
                </span>
                <span class="text-gray-600">Room is currently booked and occupied</span>
            </div>
            <div class="flex items-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">
                    Available
                </span>
                <span class="text-gray-600">Room is available for booking</span>
            </div>
            <div class="flex items-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-2">
                    Disabled
                </span>
                <span class="text-gray-600">Room is disabled/out of service</span>
            </div>
        </div>
        <div class="mt-2 text-xs text-gray-500">
            * Current date: {{ today }}
        </div>
    </div>
</div>
{% endblock %}
